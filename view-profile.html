<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrimony Portal - View Profile</title>

    <!-- DEFAULT Open Graph / Twitter Tags (Overwritten by JS) -->
    <meta property="og:title" content="Matrimony Profile" /> <meta name="twitter:title" content="Matrimony Profile" />
    <meta property="og:description" content="View a Matrimony profile." /> <meta name="twitter:description" content="View a Matrimony profile." />
    <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=Matrimony" /> <meta name="twitter:image" content="https://via.placeholder.com/1200x630.png?text=Matrimony" />
    <meta property="og:url" content="" /> <meta name="twitter:card" content="summary_large_image" />
    <meta property="og:type" content="profile" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Boxicons for icons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- Firebase -->
    <script type="module" src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"></script>

    <style>
        /* Use Inter font */
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom scrollbar for thumbnails */
        .thumbnail-container::-webkit-scrollbar { height: 5px; }
        .thumbnail-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .thumbnail-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .thumbnail-container::-webkit-scrollbar-thumb:hover { background: #aaa; }
        /* Firefox scrollbar */
        .thumbnail-container { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; }

        /* Sidebar scrollbar */
         .sidebar { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; }
         .sidebar::-webkit-scrollbar { width: 5px; }
         .sidebar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
         .sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
         .sidebar::-webkit-scrollbar-thumb:hover { background: #aaa; }

         /* Main area scrollbar */
          .main-area { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; }
         .main-area::-webkit-scrollbar { width: 8px; }
         .main-area::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
         .main-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
         .main-area::-webkit-scrollbar-thumb:hover { background: #aaa; }

        /* Custom spinner animation */
        .spinner {
            border: 3px solid rgba(51, 192, 114, 0.2); 
            border-bottom-color: #33c072; 
            animation: rotation 1s linear infinite;
        }
         @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
         
         /* Hide scrollbar default arrows in number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Overlay for mobile menu -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity duration-300"></div>
    
    <!-- Dashboard Container -->
    <div id="dashboard-container" class="grid lg:grid-cols-[260px_1fr] h-screen max-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white border-r border-gray-200 p-6 flex flex-col fixed lg:relative inset-y-0 left-0 z-50 w-64 lg:w-auto h-full max-h-screen transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out overflow-y-auto">
            <button id="sidebar-close-btn" class="absolute top-4 right-4 text-red-500 text-2xl lg:hidden"><i class='bx bx-x'></i></button>
            <div class="flex justify-between items-center mb-12">
                <div class="h-10 bg-gray-200 rounded-lg w-32 flex items-center justify-center font-bold text-gray-500 text-sm">Matrimony Admin</div>
            </div>
            <nav class="flex-grow">
                <ul class="flex flex-col space-y-2">
                    <!-- Nav items -->
                    <li><a href="#" id="nav-dashboard-link" class="flex items-center gap-4 text-gray-700 font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors"><i class='bx bx-home-alt text-xl text-gray-500'></i> Dashboard</a></li>
                    <li><a href="create-profile.html" id="nav-create-profile-link" class="flex items-center gap-4 text-gray-700 font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors"><i class='bx bx-user-plus text-xl text-gray-500'></i> Create Profile</a></li>
                    <li><a href="search-profiles.html" id="nav-search-profiles-link" class="flex items-center gap-4 text-gray-700 font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors"><i class='bx bx-search text-xl text-gray-500'></i> Search Profiles</a></li>
                    <li id="nav-manage-users-item" class="hidden"><a href="admin-users.html" id="nav-manage-users-link" class="flex items-center gap-4 text-gray-700 font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors"><i class='bx bx-group text-xl text-gray-500'></i> Manage Users</a></li>
                    <li id="nav-manage-profiles-item" class="hidden"><a href="admin-profiles.html" id="nav-manage-profiles-link" class="flex items-center gap-4 text-gray-700 font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors"><i class='bx bx-id-card text-xl text-gray-500'></i> Manage Profiles</a></li>
                    <li id="nav-global-history-item" class="hidden"><a href="admin-history.html" id="nav-global-history-link" class="flex items-center gap-4 text-gray-700 font-medium py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors"><i class='bx bx-history text-xl text-gray-500'></i> Global History</a></li>
                </ul>
            </nav>
            <!-- Profile Section -->
            <div id="profile-section" class="mt-auto pt-6 border-t border-gray-200 cursor-pointer group">
                <div class="flex items-center gap-3">
                    <img id="sidebar-user-avatar" src="https://via.placeholder.com/40" alt="User Avatar" class="w-10 h-10 rounded-full object-cover bg-gray-300">
                    <div class="flex-grow min-w-0">
                        <span id="current-user-email" class="font-semibold text-sm block truncate text-gray-800">Loading...</span>
                        <span id="current-user-role" class="text-xs text-gray-500 block truncate">Role</span>
                    </div>
                    <i class='bx bx-chevron-down text-gray-500 text-xl transition-transform group-[.active]:rotate-180'></i>
                </div>
            </div>
            <!-- Profile Popup -->
            <div id="profile-popup" class="absolute bottom-[90px] left-6 right-6 bg-white rounded-xl shadow-lg border border-gray-200 p-3 z-[100] opacity-0 pointer-events-none transform scale-95 translate-y-2 transition-all duration-200 ease-out group-[.active]:opacity-100 group-[.active]:pointer-events-auto group-[.active]:scale-100 group-[.active]:translate-y-0">
                 <div class="flex items-center gap-3 pb-3 border-b border-gray-200 mb-2">
                     <img id="popup-user-avatar" src="https://via.placeholder.com/40" alt="User Avatar" class="w-10 h-10 rounded-full object-cover bg-gray-300">
                     <div class="flex-grow min-w-0">
                         <span id="popup-user-email" class="font-semibold text-sm block truncate text-gray-800">Loading...</span>
                         <span id="popup-user-role" class="text-xs text-gray-500 block truncate">Role</span>
                     </div>
                 </div>
                 <ul class="space-y-1">
                     <li><a href="#" class="flex items-center gap-3 px-3 py-1.5 text-sm text-gray-700 rounded-md hover:bg-gray-100"><i class='bx bx-user text-base text-gray-500'></i> Profile Settings</a></li>
                     <li><a href="#" class="logout flex items-center gap-3 px-3 py-1.5 text-sm text-red-600 rounded-md hover:bg-red-50" id="logout-btn"><i class='bx bx-log-out text-base text-red-500'></i> Logout</a></li>
                 </ul>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-area" class="main-area overflow-y-auto max-h-screen">
            <header class="sticky top-0 z-30 bg-white border-b border-gray-200 px-6 lg:px-12 py-4 flex justify-between items-center">
                 <button id="menu-toggle" class="text-gray-700 text-2xl lg:hidden mr-4"><i class='bx bx-menu'></i></button>
                <h1 id="main-header-title" class="text-xl font-semibold text-gray-800">View Profile</h1>
                 <!-- Placeholder for potential header actions -->
                 <div></div>
            </header>
            
            <section class="content-body p-6 lg:p-12">
                 <!-- Loading/Error Message -->
                 <div id="loading-status" class="bg-blue-100 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg mb-6 text-center">Loading profile...</div>
                 
                 <!-- Profile Content Container -->
                 <div id="profile-view-container" class="hidden"> 
                     <!-- Content generated by JS -->
                     <!-- Example structure (will be replaced): -->
                     <!-- <div class="grid lg:grid-cols-[400px_1fr] gap-8 bg-white p-8 rounded-xl shadow-sm border border-gray-200"> -->
                         <!-- Image Gallery Column -->
                         <!-- <div class="image-gallery"></div> -->
                         <!-- Details Column -->
                         <!-- <div class="profile-details-content"></div> -->
                     <!-- </div> -->
                 </div>
            </section>
        </main>
    </div>

    <!-- Feedback Toast -->
     <div id="toast-message" class="fixed bottom-5 right-5 z-[100] px-5 py-3 rounded-lg shadow-md text-white font-medium transition-all duration-300 ease-out translate-y-16 opacity-0">
        Copied!
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, updateDoc, serverTimestamp, addDoc } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAuxA-e71uX_uLDe6oyFU69q-eLfgUzbXA",
            authDomain: "harsha-jw.firebaseapp.com",
            projectId: "harsha-jw",
            storageBucket: "harsha-jw.firebasestorage.app",
            messagingSenderId: "471408120499",
            appId: "1:471408120499:web:91e61514ad3703ce3b16c6",
            measurementId: "G-NBC16X4R1T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserRole = null;
        const hardcodedMatrimonyGroups = [ { id: 'US', name: 'US' }, { id: 'BY_OTHERS', name: 'BY OTHERS' } ];
        let currentImageIndex = 0; 
        let photoURLs = []; 
        let profileGlobal = null; 

        // --- UI Shell Elements ---
        const sidebarUserAvatar = document.getElementById('sidebar-user-avatar'); const popupUserAvatar = document.getElementById('popup-user-avatar'); const sidebarUserName = document.getElementById('current-user-email'); const sidebarUserRole = document.getElementById('current-user-role'); const popupUserEmail = document.getElementById('popup-user-email'); const popupUserRole = document.getElementById('popup-user-role'); const logoutBtn = document.getElementById('logout-btn'); const menuToggle = document.getElementById('menu-toggle'); const sidebar = document.getElementById('sidebar'); const sidebarCloseBtn = document.getElementById('sidebar-close-btn'); const overlay = document.getElementById('overlay'); const mainHeaderTitle = document.getElementById('main-header-title'); const navDashboardLink = document.getElementById('nav-dashboard-link'); const navCreateProfileLink = document.getElementById('nav-create-profile-link'); const navSearchProfilesLink = document.getElementById('nav-search-profiles-link'); const navManageUsersLink = document.getElementById('nav-manage-users-link'); const navManageProfilesLink = document.getElementById('nav-manage-profiles-link'); const navGlobalHistoryLink = document.getElementById('nav-global-history-link'); const navManageUsersItem = document.getElementById('nav-manage-users-item'); const navManageProfilesItem = document.getElementById('nav-manage-profiles-item'); const navGlobalHistoryItem = document.getElementById('nav-global-history-item'); const dashboardContainer = document.getElementById('dashboard-container'); const mainArea = document.getElementById('main-area');

        // --- Page Specific Elements ---
        const profileViewContainer = document.getElementById('profile-view-container');
        const loadingStatus = document.getElementById('loading-status');
        const toastMessage = document.getElementById('toast-message');

        // --- Utility Functions ---
        function showToast(message, isSuccess = true) {
             toastMessage.textContent = message;
             toastMessage.classList.remove('bg-green-500', 'bg-red-500', 'translate-y-16', 'opacity-0');
             toastMessage.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');
             toastMessage.classList.add('translate-y-0', 'opacity-100'); // Show
             setTimeout(() => {
                 toastMessage.classList.remove('translate-y-0', 'opacity-100');
                 toastMessage.classList.add('translate-y-16', 'opacity-0'); // Hide
             }, 3000);
        }
        function getMatrimonyGroupName(groupId) { if (!groupId) return 'N/A'; const group = hardcodedMatrimonyGroups.find(g => g.id === groupId); return group ? group.name : 'Unknown'; }
        function calculateAge(dateOfBirthString) { if (!dateOfBirthString) return 'N/A'; try { const dob = new Date(dateOfBirthString); const today = new Date(); let age = today.getFullYear() - dob.getFullYear(); const m = today.getMonth() - dob.getMonth(); if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; } return age >= 0 ? age : 'N/A'; } catch (e) { return 'N/A'; } }
        function formatNumber(num) { return num !== null && num !== undefined ? num.toLocaleString('en-IN') : 'N/A'; }
        function formatStatus(status) { return status ? status.charAt(0).toUpperCase() + status.slice(1) : 'N/A'; }
        
        // --- Meta Tag Update Function ---
         function updateMetaTag(propertyOrName, content, isNameAttribute = false) { const selector = isNameAttribute ? `meta[name="${propertyOrName}"]` : `meta[property="${propertyOrName}"]`; let element = document.querySelector(selector); if (!element) { element = document.createElement('meta'); if (isNameAttribute) element.setAttribute('name', propertyOrName); else element.setAttribute('property', propertyOrName); document.head.appendChild(element); } element.setAttribute('content', content); }
        function updateAllMetaTags(title, description, image, url) { document.title = title; updateMetaTag('og:title', title); updateMetaTag('og:description', description); updateMetaTag('og:image', image); updateMetaTag('og:url', url); updateMetaTag('og:type', 'profile'); updateMetaTag('twitter:title', title, true); updateMetaTag('twitter:description', description, true); updateMetaTag('twitter:image', image, true); updateMetaTag('twitter:card', 'summary_large_image', true); }

        // --- Logging Functions ---
        async function logChange(action, entityType, entityId, details = {}) { if (!currentUser) return; try { await addDoc(collection(db, 'changeHistory'), { action, entityType, entityId, userId: currentUser.uid, userEmail: currentUser.email, timestamp: serverTimestamp(), details: JSON.stringify(details) }); } catch (error) { console.error("Error logging global change:", error); } }
        async function logProfileFieldChange(profileId, fieldName, oldValue, newValue) { if (!currentUser || oldValue === newValue) return; try { await addDoc(collection(db, 'profiles', profileId, 'history'), { fieldName, oldValue: oldValue ?? null, newValue: newValue ?? null, changedByUid: currentUser.uid, changedByEmail: currentUser.email, timestamp: serverTimestamp() }); } catch (error) { console.error(`Error logging field change for ${fieldName}:`, error); } }

        // --- UI Shell Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => { 
             const profileSection = document.getElementById('profile-section'); const profilePopup = document.getElementById('profile-popup'); if (profileSection) { profileSection.addEventListener('click', e => { e.stopPropagation(); profilePopup.classList.toggle('active'); profileSection.classList.toggle('active'); }); } document.addEventListener('click', e => { if (profileSection && !profileSection.contains(e.target) && profilePopup && !profilePopup.contains(e.target)) { profilePopup.classList.remove('active'); profileSection.classList.remove('active'); } }); const toggleMenu = () => { sidebar.classList.toggle('-translate-x-full'); overlay.classList.toggle('hidden'); }; if (menuToggle) menuToggle.addEventListener('click', toggleMenu); if (sidebarCloseBtn) sidebarCloseBtn.addEventListener('click', toggleMenu); if (overlay) overlay.addEventListener('click', toggleMenu); if (logoutBtn) logoutBtn.addEventListener('click', async () => { try { await signOut(auth); window.location.href = 'index.html'; } catch (error) { console.error("Error signing out:", error); } });
        });

        // --- Auth State Change & Initial Load ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user; 
            const urlParams = new URLSearchParams(window.location.search);
            const profileId = urlParams.get('profileId');
            const sourcePage = urlParams.get('source'); 

             // --- Conditional UI: Sidebar and Layout ---
             if (!user) {
                 sidebar?.classList.add('hidden'); // Hide sidebar completely
                 dashboardContainer?.classList.remove('lg:grid-cols-[260px_1fr]');
                 dashboardContainer?.classList.add('grid-cols-1'); // Make main content full width
                 mainArea?.classList.add('col-span-1'); // Ensure it takes the span
             } else {
                 sidebar?.classList.remove('hidden');
                 dashboardContainer?.classList.add('lg:grid-cols-[260px_1fr]');
                 dashboardContainer?.classList.remove('grid-cols-1');
                 mainArea?.classList.remove('col-span-1');
             }

            // --- Highlight Menu Item ---
            const navLinks = [navDashboardLink, navCreateProfileLink, navSearchProfilesLink, navManageUsersLink, navManageProfilesLink, navGlobalHistoryLink];
            navLinks.forEach(link => link?.classList.remove('active', 'bg-gray-100', 'font-semibold')); // Reset styles
            let activeLink = null;
            switch (sourcePage) {
                case 'search': activeLink = navSearchProfilesLink; break;
                case 'admindash': activeLink = navDashboardLink; break;
                case 'employeedash': activeLink = navDashboardLink; break;
                case 'manageusers': activeLink = navManageUsersLink; break;
                case 'manageprof': activeLink = navManageProfilesLink; break;
                case 'create': activeLink = navCreateProfileLink; break; // Add if linking from create
                default: activeLink = navDashboardLink; break; // Default to dashboard
            }
             if (activeLink) {
                 activeLink.classList.add('active', 'bg-gray-100', 'font-semibold');
                 // Also style the icon if using the 'active' state for it
                 activeLink.querySelector('i')?.classList.add('text-green-600');
             }

            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    const userData = userDoc.exists() ? userDoc.data() : {};
                    currentUserRole = userData.role;
                    const userStatus = userData.status;

                    if (sidebarUserName) sidebarUserName.textContent = user.email;
                    if (sidebarUserRole) sidebarUserRole.textContent = currentUserRole ? formatStatus(currentUserRole) : 'N/A';
                    if (popupUserEmail) popupUserEmail.textContent = user.email;
                    if (popupUserRole) popupUserRole.textContent = currentUserRole ? formatStatus(currentUserRole) : 'N/A';
                    const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${user.email?.charAt(0)}&background=random`;
                    if (sidebarUserAvatar) sidebarUserAvatar.src = avatarUrl;
                    if (popupUserAvatar) popupUserAvatar.src = avatarUrl;
                    if (logoutBtn) logoutBtn.classList.remove('hidden');

                    if (userStatus === 'pending') { window.location.href = 'pending.html'; return; }
                    if (userStatus === 'denied' || userStatus === 'suspended') { window.location.href = 'denied.html'; return; }

                    if (navManageUsersItem) navManageUsersItem.classList.toggle('hidden', currentUserRole !== 'admin');
                    if (navManageProfilesItem) navManageProfilesItem.classList.toggle('hidden', currentUserRole !== 'admin');
                    if (navGlobalHistoryItem) navGlobalHistoryItem.classList.toggle('hidden', currentUserRole !== 'admin');
                    if (navDashboardLink) navDashboardLink.href = (currentUserRole === 'admin' ? 'admin-dashboard.html' : 'employee-dashboard.html');

                } catch (error) { /* Handle error, allow viewing */ 
                    console.error("Error fetching user role:", error); currentUserRole = null; 
                    if (sidebarUserName) sidebarUserName.textContent = user.email; if (logoutBtn) logoutBtn.classList.remove('hidden'); 
                }
            } else {
                // Not logged in (UI already handled above)
                currentUserRole = null;
                 if (sidebarUserName) sidebarUserName.textContent = 'Guest';
                 if (logoutBtn) logoutBtn.classList.add('hidden');
                 [navManageUsersItem, navManageProfilesItem, navGlobalHistoryItem].forEach(item => item?.classList.add('hidden'));
            }

            // Load profile 
            if (profileId) { await displayShareableProfile(profileId); } 
            else { loadingStatus.textContent = 'Error: No profile ID provided.'; loadingStatus.className = 'text-red-600 font-medium text-center p-4 bg-red-100 border border-red-200 rounded-lg'; }
        });

        // --- Image Gallery Functions ---
        function updateMainImage(index) { /* ... (keep as is) ... */ }
        function setupGalleryNavigation() { /* ... (keep as is) ... */ }

        // --- Display Profile Function ---
        async function displayShareableProfile(profileId) {
            loadingStatus.classList.remove('hidden');
            profileViewContainer.classList.add('hidden');
            profileViewContainer.innerHTML = ''; 

            try {
                const profileDoc = await getDoc(doc(db, 'profiles', profileId));
                if (!profileDoc.exists()) { loadingStatus.textContent = 'Profile not found.'; loadingStatus.className = 'text-red-600 font-medium text-center p-4 bg-red-100 border border-red-200 rounded-lg'; return; }
                
                profileGlobal = { id: profileDoc.id, ...profileDoc.data() }; 
                const profile = profileGlobal; 
                
                photoURLs = profile.photoURLs || (profile.photoURL ? [profile.photoURL] : []); 
                currentImageIndex = 0; 

                // --- Update Meta Tags ---
                const currentAge = calculateAge(profile.dateOfBirth);
                const pageTitle = `Profile: ${profile.name} (${currentAge}, ${profile.city || profile.location || 'N/A'})`;
                const pageDescription = `${formatStatus(profile.maritalStatus)}, ${profile.religion || ''} ${profile.cast || ''}. ${profile.education || ''}, ${profile.profession || ''}. View full profile.`;
                const imageUrl = photoURLs.length > 0 ? photoURLs[0] : `https://ui-avatars.com/api/?name=${profile.name?.split(' ').join('+')}&background=random&size=1200`;
                const canonicalUrl = `${window.location.origin}${window.location.pathname}?profileId=${profile.id}`;
                updateAllMetaTags(pageTitle, pageDescription, imageUrl, canonicalUrl);
                if (mainHeaderTitle) mainHeaderTitle.textContent = `View Profile: ${profile.name}`;

                // --- Build HTML with Tailwind ---
                const imageGalleryHTML = `
                    <div class="image-gallery">
                        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden mb-4 border border-gray-200">
                            <img id="main-profile-image" class="absolute inset-0 w-full h-full object-contain transition-opacity duration-150" src="${photoURLs.length > 0 ? photoURLs[0] : 'https://via.placeholder.com/400?text=No+Photo'}" alt="Profile Photo 1">
                             <button class="gallery-nav prev absolute top-1/2 left-2 transform -translate-y-1/2 w-9 h-9 bg-black/40 text-white rounded-full text-2xl cursor-pointer flex items-center justify-center transition hover:bg-black/60 z-[5] ${photoURLs.length <= 1 ? 'hidden' : ''}" id="gallery-prev"><i class='bx bx-chevron-left'></i></button>
                             <button class="gallery-nav next absolute top-1/2 right-2 transform -translate-y-1/2 w-9 h-9 bg-black/40 text-white rounded-full text-2xl cursor-pointer flex items-center justify-center transition hover:bg-black/60 z-[5] ${photoURLs.length <= 1 ? 'hidden' : ''}" id="gallery-next"><i class='bx bx-chevron-right'></i></button>
                        </div>
                        <div class="thumbnail-container flex gap-3 overflow-x-auto pb-1.5" id="thumbnail-container">
                             ${photoURLs.map((url, index) => `
                                 <img src="${url}" alt="Thumbnail ${index + 1}" class="thumbnail w-[60px] h-[60px] object-cover rounded-md border-2 border-transparent cursor-pointer flex-shrink-0 transition opacity-70 hover:opacity-100 ${index === 0 ? 'active border-green-500 opacity-100' : ''}" data-index="${index}">
                             `).join('')}
                             ${photoURLs.length === 0 ? '<p class="text-sm text-gray-500">No photos available.</p>' : ''}
                        </div>
                    </div>`;

                 // Helper to create detail items, handling N/A
                const detailItem = (label, value) => value ? `<div class="detail-item text-sm"><strong class="block text-gray-500 font-medium text-xs mb-1">${label}:</strong> <span class="text-gray-800">${value}</span></div>` : '';

                const profileDetailsHTML = `
                    <div class="profile-details-content">
                        <div class="flex items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-900">${profile.name}</h2>
                             <span class="profile-status-badge ml-3 capitalize text-xs font-semibold px-2.5 py-0.5 rounded-full ${
                                profile.profileStatus === 'active' ? 'bg-green-100 text-green-800' : 
                                profile.profileStatus === 'inactive' ? 'bg-yellow-100 text-yellow-800' : 
                                profile.profileStatus === 'married' ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'
                             }">${formatStatus(profile.profileStatus || 'N/A')}</span>
                        </div>

                        <div class="space-y-6"> 
                            <!-- Sections using Tailwind -->
                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Personal Details</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                    ${detailItem('Gender', formatStatus(profile.gender))}
                                    ${detailItem('Age / DOB', `${currentAge} / ${profile.dateOfBirth || 'N/A'}`)}
                                    ${detailItem('Marital Status', formatStatus(profile.maritalStatus))}
                                    ${detailItem('Height', profile.height ? profile.height + ' cm' : 'N/A')}
                                    ${detailItem('Weight', profile.weight ? profile.weight + ' kg' : 'N/A')}
                                    ${detailItem('Body Type', formatStatus(profile.bodyType))}
                                    ${detailItem('Complexion', formatStatus(profile.complexion))}
                                    ${detailItem('Mother Tongue', profile.motherTongue)}
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Contact Details</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                     ${detailItem('Primary Phone', profile.phonePrimary)}
                                     ${detailItem('Secondary Phone', profile.phoneSecondary)}
                                     ${detailItem('Email', profile.email)}
                                </div>
                            </div>
                        
                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Professional & Education</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                    ${detailItem('Education', profile.education)}
                                    ${detailItem('Profession', profile.profession)}
                                    ${detailItem('Annual Income', profile.annualIncome ? 'â‚¹ ' + formatNumber(profile.annualIncome) : 'N/A')}
                                </div>
                            </div>

                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Location</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                    ${detailItem('Current Location', profile.location)}
                                    ${detailItem('City', profile.city)}
                                    ${detailItem('State', profile.state)}
                                    ${detailItem('Country', profile.country)}
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Religious & Horoscope</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                     ${detailItem('Religion', profile.religion)}
                                     ${detailItem('Cast', profile.cast)}
                                     ${detailItem('Subcast', profile.subcast)}
                                     ${detailItem('Gotram/Gothra', profile.gotram)}
                                     ${detailItem('Star (Nakshatra)', profile.star)}
                                     ${detailItem('Rasi (Moon Sign)', profile.rasi)}
                                     ${detailItem('Dosham', formatStatus(profile.dosham))}
                                </div>
                            </div>

                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Family Details</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                    ${detailItem("Father's Name", profile.fatherName)}
                                    ${detailItem("Father's Status", formatStatus(profile.fatherStatus))}
                                    ${detailItem("Mother's Name", profile.motherName)}
                                    ${detailItem("Mother's Status", formatStatus(profile.motherStatus))}
                                    ${detailItem('Brothers', profile.brothers ?? 'N/A')}
                                    ${detailItem('Sisters', profile.sisters ?? 'N/A')}
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">Lifestyle</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                    ${detailItem('Eating Habits', formatStatus(profile.eatingHabits))}
                                    ${detailItem('Smoking Habit', formatStatus(profile.smokingHabit))}
                                    ${detailItem('Drinking Habit', formatStatus(profile.drinkingHabit))}
                                </div>
                            </div>

                            <div class="details-section">
                                <h3 class="text-sm font-semibold text-green-700 mb-3 pb-2 border-b border-gray-200">About & Group</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3 mb-4">
                                     ${detailItem('Matrimony Group', getMatrimonyGroupName(profile.matrimonyGroupId))}
                                </div>
                                <p class="profile-bio text-gray-600 text-sm leading-relaxed">${profile.bio || 'No bio provided.'}</p>
                            </div>

                            <!-- Action Buttons Container -->
                            <div class="action-buttons-container mt-8 pt-6 border-t border-gray-200 flex flex-wrap gap-3">
                                <!-- Share buttons (only if logged in) -->
                                ${currentUser ? `
                                <button id="copy-link-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition duration-150 ease-in-out">
                                    <i class='bx bx-link text-lg'></i><span class="btn-text">Copy Share Link</span>
                                </button>
                                <button id="copy-details-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition duration-150 ease-in-out">
                                    <i class='bx bx-copy text-lg'></i><span class="btn-text">Copy Basic Details</span>
                                </button>
                                ` : ''}
                                
                                <!-- Status action buttons (only if staff) -->
                                <div id="profile-status-actions" class="flex flex-wrap gap-3"></div>
                            </div>

                             <!-- History (only if staff) -->
                            <div id="field-change-history" class="mt-8 pt-6 border-t border-gray-200"></div>
                        </div>
                    </div>`;

                 // Use Tailwind classes for the main container
                profileViewContainer.className = 'grid lg:grid-cols-[400px_1fr] gap-8 bg-white p-6 lg:p-8 rounded-xl shadow-sm border border-gray-200';
                profileViewContainer.innerHTML = imageGalleryHTML + profileDetailsHTML;
                profileViewContainer.classList.remove('hidden');
                loadingStatus.classList.add('hidden');

                // --- Add Gallery Listeners ---
                 const thumbnails = profileViewContainer.querySelectorAll('.thumbnail');
                 thumbnails.forEach(thumb => { thumb.addEventListener('click', (e) => updateMainImage(parseInt(e.target.dataset.index))); });
                 setupGalleryNavigation(); 

                // --- Add Staff Actions & History (Conditional) ---
                if (currentUser && (currentUserRole === 'admin' || currentUserRole === 'employee')) {
                    const statusActionsContainer = document.getElementById('profile-status-actions');
                    if(statusActionsContainer) {
                         let statusButtonsHTML = '';
                          // Add Tailwind classes to status buttons
                          if (profile.profileStatus !== 'married') statusButtonsHTML += `<button id="mark-married-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg transition" data-id="${profile.id}" data-status="married">Mark as Married</button>`;
                          if (profile.profileStatus !== 'inactive') statusButtonsHTML += `<button id="deactivate-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition" data-id="${profile.id}" data-status="inactive">Deactivate Profile</button>`;
                          if (profile.profileStatus !== 'active') statusButtonsHTML += `<button id="reactivate-btn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition" data-id="${profile.id}" data-status="active">Reactivate Profile</button>`;
                          statusActionsContainer.innerHTML = statusButtonsHTML;

                         // Re-attach event listeners
                         if (document.getElementById('mark-married-btn')) document.getElementById('mark-married-btn').addEventListener('click', (e) => updateProfileStatus(e.target.dataset.id, e.target.dataset.status));
                         if (document.getElementById('deactivate-btn')) document.getElementById('deactivate-btn').addEventListener('click', (e) => updateProfileStatus(e.target.dataset.id, e.target.dataset.status));
                         if (document.getElementById('reactivate-btn')) document.getElementById('reactivate-btn').addEventListener('click', (e) => updateProfileStatus(e.target.dataset.id, e.target.dataset.status));
                    }
                    
                    // Fetch and display history
                    const historyContainer = document.getElementById('field-change-history');
                    if (historyContainer) {
                        const historySnapshot = await getDocs(query(collection(db, 'profiles', profileId, 'history'), orderBy('timestamp', 'desc')));
                        const fieldHistory = historySnapshot.docs.map(doc => doc.data());
                        if (fieldHistory.length > 0) {
                            historyContainer.innerHTML = `
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Field Change History</h3>
                                <ul class="space-y-2">
                                    ${fieldHistory.map(entry => `
                                        <li class="bg-gray-50 border border-gray-200 rounded-md p-3 text-xs">
                                             <span class="float-right text-gray-400">${entry.timestamp ? new Date(entry.timestamp.toDate()).toLocaleString() : ''}</span>
                                            <strong class="text-blue-600">${entry.changedByEmail || 'System'}</strong> changed 
                                            <strong class="text-gray-700">${entry.fieldName}</strong> from
                                            <code class="text-red-600 bg-red-50 px-1 rounded text-xs">${JSON.stringify(entry.oldValue) ?? '""'}</code> to
                                            <code class="text-green-600 bg-green-50 px-1 rounded text-xs">${JSON.stringify(entry.newValue) ?? '""'}</code>
                                        </li>
                                    `).join('')}
                                </ul>`;
                        } else {
                             historyContainer.innerHTML = '<h3 class="text-lg font-semibold text-gray-800 mb-4">Field Change History</h3><p class="text-sm text-gray-500">No changes recorded.</p>';
                        }
                    }
                }

                // Add Share Button Listeners (only if logged in)
                if (currentUser) {
                    document.getElementById('copy-link-btn')?.addEventListener('click', (e) => copyShareLink(profile, e.currentTarget));
                    document.getElementById('copy-details-btn')?.addEventListener('click', (e) => copyBasicDetails(profile, e.currentTarget));
                }

            } catch (error) {
                console.error("Error displaying profile:", error);
                loadingStatus.textContent = `Error: ${error.message}`;
                loadingStatus.className = 'text-red-600 font-medium text-center p-4 bg-red-100 border border-red-200 rounded-lg';
            }
        }

        // --- Action Functions ---
        async function updateProfileStatus(profileId, newStatus) { /* ... (Keep existing logic, maybe update toast) ... */ 
             if (!currentUser || (!['admin', 'employee'].includes(currentUserRole))) { showToast('Permission denied.', false); return; }
             if (currentUserRole !== 'admin' && newStatus === 'active') { showToast('Only Admins can reactivate.', false); return; }
             // Replace confirm with a proper modal in a real app
             if (!confirm(`Are you sure you want to change status to '${newStatus.toUpperCase()}'?`)) return; 

             try {
                const profileRef = doc(db, 'profiles', profileId);
                const oldProfileDoc = await getDoc(profileRef);
                const oldStatus = oldProfileDoc.exists() ? oldProfileDoc.data().profileStatus : 'unknown';

                await updateDoc(profileRef, { profileStatus: newStatus, updatedAt: serverTimestamp(), updatedBy: currentUser.uid });
                await logChange('update_profile_status', 'profile', profileId, { oldStatus: oldStatus, newStatus: newStatus });
                await logProfileFieldChange(profileId, 'profileStatus', oldStatus, newStatus);

                showToast(`Status updated to '${newStatus}'!`, true);
                await displayShareableProfile(profileId); // Refresh view
            } catch (error) { console.error("Error updating status:", error); showToast(`Error: ${error.message}`, false); }
        }

        function showCopyFeedback(buttonElement) {
            const originalText = buttonElement.querySelector('.btn-text').textContent;
            const originalIcon = buttonElement.querySelector('i').className;
            
            buttonElement.querySelector('.btn-text').textContent = 'Copied!';
            buttonElement.querySelector('i').className = 'bx bx-check text-lg';
            buttonElement.disabled = true;

            setTimeout(() => {
                 buttonElement.querySelector('.btn-text').textContent = originalText;
                 buttonElement.querySelector('i').className = originalIcon;
                 buttonElement.disabled = false;
            }, 2000); // Revert after 2 seconds
        }

        function copyShareLink(profile, buttonElement) {
             const shareUrl = `${window.location.origin}${window.location.pathname}?profileId=${profile.id}`;
             navigator.clipboard.writeText(shareUrl)
                 .then(() => {
                      showCopyFeedback(buttonElement);
                      // showToast('Share link copied!', true); // Optional: Keep toast too
                 })
                 .catch(err => { console.error('Copy failed: ', err); showToast('Copy failed.', false); });
        }

        function copyBasicDetails(profile, buttonElement) {
            const currentAge = calculateAge(profile.dateOfBirth);
            // --- UPDATED: Removed link from details ---
            const basicDetails = `
Name: ${profile.name || 'N/A'}
Age: ${currentAge}
Location: ${profile.location || 'N/A'}
Education: ${profile.education || 'N/A'}
Profession: ${profile.profession || 'N/A'}
Status: ${formatStatus(profile.profileStatus || 'N/A')} 
            `.trim();
            navigator.clipboard.writeText(basicDetails)
                .then(() => {
                      showCopyFeedback(buttonElement);
                     // showToast('Basic details copied!', true); // Optional: Keep toast too
                })
                .catch(err => { console.error('Copy failed: ', err); showToast('Copy failed.', false); });
        }

    </script>
</body>
</html>
